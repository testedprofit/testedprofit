<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profitnet | Algorand Security Lab</title>
    <meta name="description" content="Interactive Secure Coding Lab">

    <!-- External Scripts & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0A091B',
                        accent: {
                            teal: '#2DD4BF',
                            emerald: '#10B981',
                            blue: '#60A5FA'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A091B;
            color: #E5E7EB;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden; /* App-like feel */
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Hero Glow from Template */
        .hero-glow {
            background: radial-gradient(circle at 30% 20%, rgba(45, 212, 191, 0.15) 0%, transparent 60%),
                        radial-gradient(circle at 70% 80%, rgba(96, 165, 250, 0.1) 0%, transparent 60%);
            will-change: opacity;
        }

        .bg-grid-pattern {
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                              linear-gradient(to right, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 2.5rem 2.5rem;
        }

        /* Editor Scrollbar */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #0A091B; }
        textarea::-webkit-scrollbar-thumb { background: #1E293B; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #334155; }

        /* Panel Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* Mobile Menu */
        #mobile-menu {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }
        #mobile-menu.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="antialiased relative bg-primary text-gray-200 flex flex-col">

    <!-- Global Background -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute inset-0 bg-grid-pattern opacity-40"></div>
        <div class="absolute inset-0 hero-glow animate-pulse-slow"></div>
    </div>

    <!-- Sticky Navigation (Profitnet) -->
    <header class="w-full z-50 bg-slate-950/80 backdrop-blur-md border-b border-white/5 transition-all duration-300 flex-none">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">

            <!-- Logo -->
            <a href="/espanol/" class="flex items-center space-x-3 group" aria-label="Go to Homepage">
                <img src="https://emerald-urgent-cuckoo-166.mypinata.cloud/ipfs/bafybeibelhobbfhgcur4j5qmnzvnjlfkpwawy3rttzdnfr4t22ikcj263m"
                     class="h-8 w-8 transition-transform group-hover:rotate-12"
                     alt="Profitnet Logo"
                     width="32" height="32">
                <span class="text-xl font-bold tracking-tight text-white">Profitnet</span>
            </a>

            <!-- Desktop Nav -->
            <nav class="hidden lg:flex space-x-10 items-center">
                <a href="/espanol/" class="text-sm font-bold text-white hover:text-accent-emerald transition-colors duration-200">HOME</a>
                <a href="/espanol/pages/landmarks/" target="_blank" class="text-xs font-bold uppercase tracking-widest text-accent-emerald hover:text-emerald-300 transition-colors duration-200">Landmarks</a>
                <a href="/espanol/pages/PNET/" class="px-6 py-2 rounded-full border border-teal-500/30 text-[10px] font-black text-teal-400 hover:bg-teal-500/10 hover:border-teal-500/60 hover:shadow-[0_0_15px_rgba(45,212,191,0.2)] transition-all duration-300 uppercase tracking-[0.2em]">
                    $PNET Asset Dashboard
                </a>
            </nav>

            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" class="lg:hidden text-white p-2 hover:bg-white/5 rounded-lg transition-colors" aria-label="Open Menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>

        <!-- Mobile Menu Overlay -->
        <div id="mobile-menu" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl z-40 lg:hidden flex flex-col items-center justify-center space-y-8">
            <button id="close-menu-btn" class="absolute top-6 right-6 text-white p-2 hover:bg-white/10 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <a href="/espanol/" class="text-xl font-black text-white uppercase tracking-widest">Inicio</a>
            <a href="/espanol/pages/landmarks/" class="text-xl font-black text-accent-emerald uppercase tracking-widest">Landmarks</a>
            <a href="/espanol/pages/PNET/" class="text-xl font-black text-white uppercase tracking-widest">$PNET Dashboard</a>
        </div>
    </header>

    <!-- Lab Sub-Header -->
    <div class="bg-white/5 border-b border-white/5 backdrop-blur-sm px-6 py-2 flex justify-between items-center z-20">
        <h2 class="text-sm font-bold text-teal-400 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
            Security Lab <span class="text-slate-500">/</span> Anti-Rekeying
        </h2>
        <a href="https://github.com/algorandfoundation/algokit-cli" target="_blank" class="text-xs text-slate-400 hover:text-white transition-colors flex items-center gap-1">
            AlgoKit Docs
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
        </a>
    </div>

    <!-- Main Content (Flex Grow to fill space) -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative z-10">

        <!-- Left Panel: Context & Visualizer -->
        <section class="lg:w-1/2 p-8 overflow-y-auto custom-scroll border-r border-white/5 bg-slate-900/40 backdrop-blur-sm">
            <div class="max-w-2xl mx-auto space-y-8">

                <!-- Lesson Steps -->
                <div data-aos="fade-up">
                    <h2 class="text-2xl font-bold mb-4 text-white">Understanding Rekeying Attacks</h2>
                    <p class="text-slate-400 mb-4 leading-relaxed">
                        On Algorand, the <strong class="text-teal-400">Rekeying</strong> feature allows an account to change its authorized signing key without changing its public address. While useful for key rotation, it is dangerous if mishandled.
                    </p>
                    <p class="text-slate-400 mb-6 leading-relaxed">
                        <strong class="text-red-400">The Threat:</strong> A malicious smart contract might trick a user into signing a transaction that sets the <code class="bg-red-500/10 border border-red-500/20 px-1 rounded text-sm text-red-400">rekey-to</code> field to the attacker's address.
                    </p>

                    <div class="bg-blue-500/5 border-l-4 border-blue-500 p-4 mb-8 rounded-r">
                        <h3 class="font-bold text-blue-400 text-sm uppercase mb-1">Your Objective</h3>
                        <p class="text-blue-200/80 text-sm">
                            Modify the PyTeal contract on the right. Ensure the transaction is <strong>only</strong> approved if the <code class="font-mono bg-white/10 px-1 rounded text-blue-300">rekey_to</code> field is empty (ZeroAddress).
                        </p>
                    </div>
                </div>

                <!-- Interactive Visualizer -->
                <div class="bg-slate-800/50 border border-white/10 rounded-xl p-6 shadow-inner relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-teal-500/5 to-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>

                    <div class="flex justify-between items-center mb-4 relative z-10">
                        <h3 class="text-xs font-bold uppercase text-slate-500 tracking-wider">Account State Simulation</h3>
                        <span id="status-badge" class="px-2 py-1 rounded text-xs font-bold bg-slate-700 text-slate-300">WAITING FOR CODE</span>
                    </div>

                    <!-- Diagram -->
                    <div class="relative h-48 bg-slate-900/80 border border-white/5 rounded-lg flex items-center justify-center overflow-hidden z-10">

                        <!-- Account Box -->
                        <div class="absolute left-12 flex flex-col items-center z-10">
                            <div class="w-16 h-16 bg-slate-800 border border-white/10 rounded-lg flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                            </div>
                            <span class="mt-2 text-xs font-bold text-slate-500">User Wallet</span>
                        </div>

                        <!-- Connection Line -->
                        <div id="connection-line" class="h-1 w-32 bg-slate-700 transition-all duration-500"></div>

                        <!-- Key Box -->
                        <div class="absolute right-12 flex flex-col items-center z-10">
                            <div id="key-icon" class="w-16 h-16 bg-emerald-500/20 border border-emerald-500/50 rounded-full flex items-center justify-center shadow-lg transition-colors duration-500">
                                <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                            </div>
                            <span id="key-label" class="mt-2 text-xs font-bold text-emerald-500 transition-colors duration-500">User's Private Key</span>
                        </div>

                        <!-- Attack Indicator -->
                        <div id="attacker-ghost" class="absolute right-12 top-4 opacity-0 transition-opacity duration-500">
                            <span class="text-xs font-bold text-red-400 bg-red-900/30 border border-red-500/30 px-2 py-1 rounded">ATTACKER</span>
                        </div>
                    </div>

                    <p id="simulation-feedback" class="text-center text-sm mt-4 text-slate-400 h-6 relative z-10">Update the code to run simulation.</p>
                </div>

                <!-- AlgoKit Debugger Link -->
                <div class="mt-8 pt-8 border-t border-white/10">
                    <a href="https://github.com/algorandfoundation/algokit-avm-vscode-debugger" target="_blank" class="block group p-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 hover:border-teal-500/30 transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-white mb-1 group-hover:text-teal-400 transition-colors">Launch AlgoKit Debugger Guide</h4>
                                <p class="text-xs text-slate-400">Trace transactions opcode-by-opcode & visualize stack manipulation.</p>
                            </div>
                            <svg class="w-5 h-5 text-slate-500 group-hover:text-teal-400 group-hover:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </div>
                    </a>
                </div>
            </div>
        </section>

        <!-- Right Panel: Code Playground -->
        <section class="lg:w-1/2 flex flex-col relative bg-slate-950">
            <div class="flex items-center justify-between px-6 py-3 bg-black/40 border-b border-white/5 backdrop-blur">
                <span class="text-slate-400 text-xs font-mono flex items-center gap-2">
                    <svg class="w-4 h-4 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                    contract.py
                </span>
                <div class="flex gap-2">
                    <button onclick="resetCode()" class="text-xs text-slate-500 hover:text-white px-3 py-1.5 transition-colors">Reset</button>
                    <button onclick="runSimulation()" class="bg-teal-600/20 hover:bg-teal-500/30 border border-teal-500/50 text-teal-400 hover:text-teal-300 hover:shadow-[0_0_15px_rgba(45,212,191,0.2)] text-xs font-bold px-4 py-1.5 rounded transition-all flex items-center">
                        <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path></svg>
                        Run & Verify
                    </button>
                </div>
            </div>

            <div class="relative flex-1 group bg-[#0d1117]"> <!-- GitHub Dark Dimmed approximation -->
                <!-- Line Numbers -->
                <div class="absolute left-0 top-0 bottom-0 w-12 bg-black/20 border-r border-white/5 text-slate-600 font-mono text-sm pt-4 text-right pr-3 select-none leading-relaxed">
                    1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15
                </div>
                <!-- Text Area -->
                <textarea id="code-editor" class="w-full h-full bg-transparent text-slate-300 font-mono text-sm p-4 pl-14 focus:outline-none leading-relaxed spellcheck-false resize-none" spellcheck="false">
from pyteal import *

def secure_payment():
    # Define the transaction conditions
    core_checks = And(
        Txn.type_enum() == TxnType.Payment,
        Txn.receiver() == Addr("STORE_ADDRESS"),
        Txn.amount() == Int(1000000),
        Txn.fee() <= Int(1000)
    )

    # TODO: Prevent Rekeying Attacks
    # Ensure that the rekey_to field is empty (ZeroAddress)

    # <--- WRITE YOUR SECURITY CHECK HERE --->
    security_check = Int(1) # Currently unsafe!

    return And(core_checks, security_check)

# Compile Logic...
</textarea>
            </div>

            <!-- Console Output -->
            <div id="console-panel" class="h-40 bg-black border-t border-white/10 p-4 font-mono text-xs overflow-y-auto custom-scroll">
                <div class="text-slate-500 mb-2 border-b border-white/10 pb-1">CONSOLE OUTPUT</div>
                <div id="console-output"></div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Init AOS
        document.addEventListener('DOMContentLoaded', () => {
            AOS.init({ duration: 800, once: true });
        });

        // Mobile Menu Logic
        const menuBtn = document.getElementById('mobile-menu-btn');
        const closeBtn = document.getElementById('close-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        function toggleMenu(show) {
            if (show) mobileMenu.classList.add('active');
            else mobileMenu.classList.remove('active');
        }

        menuBtn.addEventListener('click', () => toggleMenu(true));
        closeBtn.addEventListener('click', () => toggleMenu(false));
        mobileMenu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => toggleMenu(false));
        });

        // Security Lab Logic
        const initialCode = `from pyteal import *

def secure_payment():
    # Define the transaction conditions
    core_checks = And(
        Txn.type_enum() == TxnType.Payment,
        Txn.receiver() == Addr("STORE_ADDRESS"),
        Txn.amount() == Int(1000000),
        Txn.fee() <= Int(1000)
    )

    # TODO: Prevent Rekeying Attacks
    # Ensure that the rekey_to field is empty (ZeroAddress)

    # <--- WRITE YOUR SECURITY CHECK HERE --->
    security_check = Int(1) # Currently unsafe!

    return And(core_checks, security_check)

# Compile Logic...`;

        const editor = document.getElementById('code-editor');
        const consoleOutput = document.getElementById('console-output');
        const statusBadge = document.getElementById('status-badge');
        const keyIcon = document.getElementById('key-icon');
        const keyLabel = document.getElementById('key-label');
        const connectionLine = document.getElementById('connection-line');
        const feedback = document.getElementById('simulation-feedback');
        const attackerGhost = document.getElementById('attacker-ghost');

        function resetCode() {
            editor.value = initialCode;
            logToConsole("Code reset to default state.", "info");
            resetVisuals();
        }

        function logToConsole(message, type) {
            const div = document.createElement('div');
            div.className = "mb-1 fade-in";

            if (type === 'error') div.className += " text-red-400";
            else if (type === 'success') div.className += " text-emerald-400";
            else div.className += " text-slate-400";

            div.innerText = `> ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function resetVisuals() {
            statusBadge.innerText = "WAITING FOR CODE";
            statusBadge.className = "px-2 py-1 rounded text-xs font-bold bg-slate-700 text-slate-300";

            keyIcon.className = "w-16 h-16 bg-emerald-500/20 border border-emerald-500/50 rounded-full flex items-center justify-center shadow-lg transition-colors duration-500";
            keyIcon.innerHTML = `<svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>`;

            keyLabel.innerText = "User's Private Key";
            keyLabel.className = "mt-2 text-xs font-bold text-emerald-500 transition-colors duration-500";
            connectionLine.className = "h-1 w-32 bg-slate-700 transition-all duration-500";
            attackerGhost.style.opacity = "0";
            feedback.innerText = "Update the code to run simulation.";
            feedback.className = "text-center text-sm mt-4 text-slate-400 h-6 relative z-10";
        }

        function runSimulation() {
            const code = editor.value;
            consoleOutput.innerHTML = "";
            resetVisuals();

            logToConsole("Compiling PyTeal mock...", "info");

            setTimeout(() => {
                const hasRekeyCheck = /Txn\.rekey_to\(\)\s*==\s*Global\.zero_address\(\)/.test(code);
                const hasInt1 = /security_check\s*=\s*Int\(1\)/.test(code);

                if (hasRekeyCheck && !hasInt1) {
                    handleSuccess();
                } else {
                    handleFailure();
                }
            }, 600);
        }

        function handleSuccess() {
            logToConsole("Compilation Successful.", "success");
            logToConsole("Simulation: Transaction signed and submitted.", "info");
            logToConsole("Verifying Authority...", "info");

            setTimeout(() => {
                statusBadge.innerText = "SECURE";
                statusBadge.className = "px-2 py-1 rounded text-xs font-bold bg-emerald-500/20 text-emerald-300 border border-emerald-500/30";
                feedback.innerText = "Success! The contract explicitly forbids rekeying.";
                feedback.className = "text-center text-sm mt-4 text-emerald-400 font-bold h-6 fade-in";
                logToConsole("PASSED: RekeyTo field is explicitly restricted to ZeroAddress.", "success");
            }, 500);
        }

        function handleFailure() {
            logToConsole("WARNING: Vulnerability Detected.", "error");

            statusBadge.innerText = "VULNERABLE";
            statusBadge.className = "px-2 py-1 rounded text-xs font-bold bg-red-500/20 text-red-300 border border-red-500/30";

            // Visual updates for attack
            keyIcon.className = "w-16 h-16 bg-red-500/20 border border-red-500/50 rounded-full flex items-center justify-center shadow-lg transition-colors duration-500";
            keyIcon.innerHTML = `<svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;

            keyLabel.innerText = "Attacker's Key";
            keyLabel.className = "mt-2 text-xs font-bold text-red-400 transition-colors duration-500";
            connectionLine.className = "h-1 w-32 bg-red-500/50 border-t-2 border-dashed border-red-400/30";
            attackerGhost.style.opacity = "1";

            feedback.innerHTML = "Attack Successful: The account has been rekeyed to a malicious address.";
            feedback.className = "text-center text-sm mt-4 text-red-400 font-bold h-6 fade-in";

            logToConsole("FAILED: No check found for Txn.rekey_to(). The transaction allowed authority rotation.", "error");
            logToConsole("HINT: Add 'Txn.rekey_to() == Global.zero_address()' to your security_check.", "info");
        }

        resetCode();
    </script>
</body>
</html>
