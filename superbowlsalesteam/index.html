<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AlgoHub (Stable Pera)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Basic CSP (loosened for CDNs). Tighten if you self-host. -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' https:;
          script-src 'self' https: 'unsafe-inline';
          style-src 'self' https: 'unsafe-inline';
          img-src 'self' https: data:;
          connect-src 'self' https:;
          frame-src 'self' https:;
        " />

  <style>
    html, body { height: 100%; font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-full">
  <div id="app" class="h-full"></div>

  <script type="module">
    // NOTE: we pin algosdk version AND force @perawallet/connect to use the same algosdk dependency
    import algosdk from "https://esm.sh/algosdk@2.13.0";
    import { PeraWalletConnect, closePeraWalletSignTxnToast } from "https://esm.sh/@perawallet/connect@1.4.2?deps=algosdk@2.13.0";

    const NODE_API = "https://mainnet-api.algonode.cloud";
    const NFD_API = "https://api.nf.domains/nfd";
    const PREMIUM_RECIPIENT_NFD = "cheetos.algo";
    const PREMIUM_COST = 1_000_000; // 1 ALGO microalgos
    const MAX_BATCH = 16;

    const state = {
      tab: "overview",
      account: null,
      unlocked: false,
      feeAddr: null,
      status: { type: "info", msg: "" },
      overview: null
    };

    const pera = new PeraWalletConnect({
      shouldShowSignTxnToast: true
    });

    const $app = document.getElementById("app");

    function setStatus(type, msg) {
      state.status = { type, msg };
      render();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function badgeHtml() {
      const { type, msg } = state.status || {};
      if (!msg) return "";
      const cls =
        type === "error" ? "bg-red-50 text-red-700 border-red-100" :
        type === "success" ? "bg-emerald-50 text-emerald-700 border-emerald-100" :
        "bg-blue-50 text-blue-700 border-blue-100";
      return `<div class="mt-4 px-4 py-3 rounded-xl border text-sm font-medium ${cls}">${escapeHtml(msg)}</div>`;
    }

    function layoutHtml(content) {
      const acct = state.account ? `
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-xs font-bold text-slate-500 uppercase">Connected</div>
              <div class="font-mono text-xs text-slate-500 truncate max-w-[220px]">${escapeHtml(state.account)}</div>
            </div>
            <button id="btnDisconnect" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm font-semibold">
              Disconnect
            </button>
          </div>
        </div>
      ` : `
        <button id="btnConnect" class="w-full px-4 py-3 rounded-2xl bg-slate-900 hover:bg-slate-800 text-white font-semibold shadow">
          Connect Pera Wallet
        </button>
      `;

      const navItem = (id, label, pro=false) => `
        <button data-tab="${id}" class="w-full text-left px-4 py-3 rounded-xl font-medium text-sm transition
          ${state.tab === id ? "bg-white border border-slate-200 shadow-sm" : "hover:bg-slate-100 text-slate-600"}">
          <div class="flex items-center justify-between">
            <span>${label}</span>
            ${pro ? `<span class="text-[10px] font-bold bg-orange-100 text-orange-700 px-2 py-0.5 rounded uppercase">Pro</span>` : ""}
          </div>
        </button>
      `;

      return `
        <div class="h-full flex">
          <aside class="w-80 border-r border-slate-200 bg-slate-50 p-4 flex flex-col gap-4">
            <div class="px-2 py-3">
              <div class="text-xl font-bold tracking-tight">AlgoHub</div>
              <div class="text-xs text-slate-500 mt-1">Stable Pera integration</div>
            </div>

            <div class="space-y-2 px-1">
              ${navItem("overview", "Wallet Overview")}
              ${navItem("cleaner", "Wallet Cleaner")}
              ${navItem("multisender", "MultiSender", true)}
            </div>

            <div class="mt-auto px-1 space-y-3">
              ${acct}
              <div class="text-[11px] text-slate-400 px-1">
                Uses Algonode mainnet endpoint. Verify addresses before sending.
              </div>
            </div>
          </aside>

          <main class="flex-1 overflow-auto">
            <div class="max-w-3xl mx-auto p-8">
              ${content}
              ${badgeHtml()}
            </div>
          </main>
        </div>
      `;
    }

    async function resolveNFD(name) {
      try {
        const res = await fetch(`${NFD_API}/${name}?view=brief`);
        if (!res.ok) return null;
        return await res.json();
      } catch { return null; }
    }

    function parseBatch(text) {
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      if (lines.length === 0) throw new Error("Paste at least one line: ADDRESS, AMOUNT");
      if (lines.length > MAX_BATCH) throw new Error(`Max ${MAX_BATCH} transactions per batch`);

      const entries = lines.map((line, idx) => {
        const parts = line.split(",").map(s => s.trim());
        if (parts.length !== 2) throw new Error(`Line ${idx+1}: expected "ADDRESS, AMOUNT"`);
        const [addr, amtStr] = parts;
        if (!algosdk.isValidAddress(addr)) throw new Error(`Line ${idx+1}: invalid address`);
        const amt = Number(amtStr);
        if (!Number.isFinite(amt) || amt <= 0) throw new Error(`Line ${idx+1}: invalid amount`);
        if (amt > 1_000_000) throw new Error(`Line ${idx+1}: amount too large (safety cap)`); // cap for safety
        return { addr, micro: Math.floor(amt * 1_000_000) };
      });

      return entries;
    }

    async function fetchOverview() {
      if (!state.account) return;
      const client = new algosdk.Algodv2("", NODE_API, "");
      const info = await client.accountInformation(state.account).do();

      const amount = info.amount || 0;
      const min = info["min-balance"] || 0;
      const available = Math.max(0, amount - min);
      const assetCount = (info.assets || []).length;
      const rekeyTo = info["auth-addr"] || null;

      state.overview = { amount, min, available, assetCount, rekeyTo };
    }

    async function connect() {
      try {
        setStatus("info", "Connecting to Pera...");
        const accounts = await pera.connect();
        state.account = accounts?.[0] || null;

        // Handle disconnect events (recommended by examples)
        pera.connector?.on("disconnect", () => {
          state.account = null;
          state.unlocked = false;
          state.overview = null;
          setStatus("info", "Disconnected.");
        });

        await fetchOverview();
        setStatus("success", "Connected.");
      } catch (e) {
        setStatus("error", e?.message || "Failed to connect.");
      }
    }

    function disconnect() {
      pera.disconnect();
      state.account = null;
      state.unlocked = false;
      state.overview = null;
      setStatus("info", "Disconnected.");
    }

    async function unlockPremium() {
      if (!state.account) return setStatus("error", "Connect wallet first.");
      if (!state.feeAddr) return setStatus("error", "Premium recipient not resolved yet.");

      try {
        setStatus("info", "Preparing unlock transaction...");
        const client = new algosdk.Algodv2("", NODE_API, "");
        const sp = await client.getTransactionParams().do();

        const txn = algosdk.makePaymentTxnWithSuggestedParamsFromObject({
          from: state.account,
          to: state.feeAddr,
          amount: PREMIUM_COST,
          suggestedParams: sp,
          note: new TextEncoder().encode("AlgoHub: Unlock")
        });

        setStatus("info", "Check Pera on your phone to sign.");
        const signed = await pera.signTransaction([[{ txn, signers: [state.account] }]]);
        closePeraWalletSignTxnToast();

        const { txId } = await client.sendRawTransaction(signed).do();
        setStatus("info", `Broadcasted. Waiting confirmation (${txId.slice(0,8)}...)`);
        await algosdk.waitForConfirmation(client, txId, 4);

        state.unlocked = true;
        setStatus("success", "Unlocked MultiSender.");
      } catch (e) {
        setStatus("error", e?.message || "Unlock failed.");
      }
    }

    async function sendBatch(text) {
      if (!state.account) return setStatus("error", "Connect wallet first.");
      if (!state.unlocked) return setStatus("error", "Unlock MultiSender first.");

      try {
        const entries = parseBatch(text);

        const client = new algosdk.Algodv2("", NODE_API, "");
        const sp = await client.getTransactionParams().do();

        const txns = entries.map(({ addr, micro }) =>
          algosdk.makePaymentTxnWithSuggestedParamsFromObject({
            from: state.account,
            to: addr,
            amount: micro,
            suggestedParams: sp,
            note: new TextEncoder().encode("AlgoHub: MultiSender")
          })
        );

        algosdk.assignGroupID(txns);

        setStatus("info", "Check Pera on your phone to sign.");
        const group = txns.map(txn => ({ txn, signers: [state.account] }));
        const signed = await pera.signTransaction([group]);
        closePeraWalletSignTxnToast();

        const { txId } = await client.sendRawTransaction(signed).do();
        setStatus("info", `Broadcasted. Waiting confirmation (${txId.slice(0,8)}...)`);
        await algosdk.waitForConfirmation(client, txId, 4);

        setStatus("success", `Sent ${txns.length} payments.`);
      } catch (e) {
        setStatus("error", e?.message || "Batch send failed.");
      }
    }

    async function init() {
      // Resolve premium NFD address early
      const nfd = await resolveNFD(PREMIUM_RECIPIENT_NFD);
      if (nfd?.depositAccount && algosdk.isValidAddress(nfd.depositAccount)) {
        state.feeAddr = nfd.depositAccount;
      }

      // Reconnect session if present
      try {
        const accounts = await pera.reconnectSession();
        if (accounts?.length) {
          state.account = accounts[0];
          await fetchOverview();
          setStatus("success", "Reconnected.");
        }
      } catch {
        // ignore
      }

      render();
    }

    function overviewHtml() {
      if (!state.account) {
        return `
          <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
            <div class="text-2xl font-bold">Wallet Overview</div>
            <div class="text-slate-500 mt-2">Connect your wallet to see balances and safety info.</div>
          </div>
        `;
      }

      const o = state.overview;
      if (!o) {
        return `
          <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
            <div class="text-2xl font-bold">Wallet Overview</div>
            <div class="text-slate-500 mt-2">Loading…</div>
          </div>
        `;
      }

      const fmtAlgo = (micro) => (micro / 1_000_000).toFixed(6);

      const rekeyWarning = o.rekeyTo ? `
        <div class="mt-4 p-4 rounded-2xl border border-amber-200 bg-amber-50 text-amber-900">
          <div class="font-bold text-sm">Rekeyed account detected</div>
          <div class="font-mono text-xs mt-2 break-all">${escapeHtml(o.rekeyTo)}</div>
          <div class="text-xs mt-2 text-amber-800">
            This account is rekeyed. Ensure you trust the authorized address before signing transactions.
          </div>
        </div>
      ` : "";

      return `
        <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-2xl font-bold">Wallet Overview</div>
              <div class="text-slate-500 mt-1 text-sm">Mainnet account snapshot.</div>
            </div>
            <button id="btnRefreshOverview" class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm font-semibold">
              Refresh
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
            <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-500 uppercase">Balance</div>
              <div class="text-xl font-bold mt-1">${fmtAlgo(o.amount)} ALGO</div>
            </div>
            <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-500 uppercase">Min Balance</div>
              <div class="text-xl font-bold mt-1">${fmtAlgo(o.min)} ALGO</div>
            </div>
            <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
              <div class="text-xs font-bold text-slate-500 uppercase">Available</div>
              <div class="text-xl font-bold mt-1">${fmtAlgo(o.available)} ALGO</div>
            </div>
          </div>

          <div class="mt-4 p-4 rounded-2xl bg-slate-50 border border-slate-200">
            <div class="text-xs font-bold text-slate-500 uppercase">ASA Count</div>
            <div class="text-lg font-bold mt-1">${o.assetCount}</div>
          </div>

          ${rekeyWarning}
        </div>
      `;
    }

    function cleanerHtml() {
      return `
        <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
          <div class="text-2xl font-bold">Wallet Cleaner</div>
          <div class="text-slate-500 mt-2">
            (Not implemented in this snippet to keep it focused on Pera reliability.)
          </div>
          <div class="text-slate-500 mt-2 text-sm">
            If you want, I’ll re-add ASA close-out with the same signing pipeline used here.
          </div>
        </div>
      `;
    }

    function multisenderHtml() {
      if (!state.account) {
        return `
          <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
            <div class="text-2xl font-bold">MultiSender</div>
            <div class="text-slate-500 mt-2">Connect your wallet to continue.</div>
          </div>
        `;
      }

      if (!state.unlocked) {
        return `
          <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
            <div class="text-2xl font-bold">Premium Feature</div>
            <div class="text-slate-500 mt-2 max-w-xl">
              Unlock MultiSender with a one-time 1 ALGO fee. We’ll show the recipient address before you sign.
            </div>

            <div class="mt-6 p-4 rounded-2xl bg-slate-50 border border-slate-200 inline-block">
              <div class="text-xs font-bold text-slate-500 uppercase">One-time fee</div>
              <div class="text-2xl font-bold">1 ALGO</div>
            </div>

            <div class="mt-6 p-4 rounded-2xl border border-slate-200 bg-white">
              <div class="text-xs font-bold text-slate-500 uppercase">Recipient</div>
              <div class="font-mono text-xs text-slate-700 mt-2 break-all">${escapeHtml(state.feeAddr || "Resolving…")}</div>
              <div class="text-xs text-slate-500 mt-2">Domain: ${escapeHtml(PREMIUM_RECIPIENT_NFD)}</div>
            </div>

            <button id="btnUnlock" class="mt-6 w-full px-5 py-3 rounded-2xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-semibold shadow hover:opacity-95">
              Unlock Now
            </button>
          </div>
        `;
      }

      return `
        <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm">
          <div class="flex items-center justify-between gap-4">
            <div>
              <div class="text-2xl font-bold">MultiSender</div>
              <div class="text-slate-500 mt-1 text-sm">Format: <span class="font-mono">ADDRESS, AMOUNT</span> (ALGO)</div>
            </div>
            <span class="text-[10px] font-bold bg-orange-100 text-orange-700 px-3 py-1 rounded-full uppercase">Premium Active</span>
          </div>

          <textarea id="batchText"
            class="mt-6 w-full h-44 p-4 rounded-2xl bg-slate-50 border border-slate-200 font-mono text-sm outline-none focus:ring-2 focus:ring-slate-200"
            placeholder="ADDRESS, AMOUNT&#10;..."></textarea>

          <button id="btnSendBatch"
            class="mt-4 w-full px-5 py-3 rounded-2xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-semibold shadow hover:opacity-95">
            Send Batch
          </button>

          <div class="mt-4 text-xs text-slate-500">
            Safety caps: max ${MAX_BATCH} txns, per-line max 1,000,000 ALGO (adjust in code).
          </div>
        </div>
      `;
    }

    function contentHtml() {
      if (state.tab === "overview") return overviewHtml();
      if (state.tab === "cleaner") return cleanerHtml();
      if (state.tab === "multisender") return multisenderHtml();
      return overviewHtml();
    }

    function render() {
      try {
        $app.innerHTML = layoutHtml(contentHtml());

        // nav
        $app.querySelectorAll("[data-tab]").forEach(btn => {
          btn.addEventListener("click", () => {
            state.tab = btn.getAttribute("data-tab");
            setStatus("info", "");
            render();
          });
        });

        // connect/disconnect
        const btnConnect = $app.querySelector("#btnConnect");
        if (btnConnect) btnConnect.addEventListener("click", connect);

        const btnDisconnect = $app.querySelector("#btnDisconnect");
        if (btnDisconnect) btnDisconnect.addEventListener("click", disconnect);

        // overview refresh
        const btnRefresh = $app.querySelector("#btnRefreshOverview");
        if (btnRefresh) btnRefresh.addEventListener("click", async () => {
          try {
            setStatus("info", "Refreshing…");
            await fetchOverview();
            setStatus("success", "Updated.");
          } catch (e) {
            setStatus("error", e?.message || "Refresh failed.");
          }
        });

        // premium unlock
        const btnUnlock = $app.querySelector("#btnUnlock");
        if (btnUnlock) btnUnlock.addEventListener("click", unlockPremium);

        // send batch
        const btnSend = $app.querySelector("#btnSendBatch");
        if (btnSend) btnSend.addEventListener("click", async () => {
          const text = $app.querySelector("#batchText")?.value || "";
          await sendBatch(text);
        });

      } catch (e) {
        // never white-screen
        $app.innerHTML = `
          <div class="p-8 max-w-3xl mx-auto">
            <div class="bg-white border border-red-200 rounded-2xl p-6">
              <div class="text-xl font-bold text-red-700">App Error</div>
              <pre class="mt-4 text-xs whitespace-pre-wrap text-slate-700">${escapeHtml(e?.stack || e?.message || String(e))}</pre>
            </div>
          </div>
        `;
      }
    }

    init();
  </script>
</body>
</html>
